<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Collective - Buller's Algorithm Visualizer</title>
    <!-- 1. Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Google Fonts (Orbitron for headlines, Lexend for body, Fira Code for mono) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Fira+Code:wght@500;700&family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Background gradient - tiled throughout entire page */
        html {
            background-color: #0a0a0a;
            min-height: 100%;
        }
        
        body {
            font-family: 'Lexend', sans-serif;
            background-color: #0a0a0a;
            letter-spacing: -0.02em;
            min-height: 100vh;
            /* Use pre-tiled/mirrored background at full screen width */
            background-image: url('materialSimBGtiled.png');
            background-size: 100% auto;
            background-position: center top;
            background-repeat: repeat-y;
            background-attachment: scroll;
        }
        
        /* Orbitron for headlines */
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }
        
        /* Use Fira Code for all mono elements */
        .font-mono {
            font-family: 'Fira Code', monospace;
        }
        
        /* Custom range slider styling to match material sim */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            width: 100%;
            height: 20px;
        }
        
        /* Gradient track for sliders */
        input[type="range"]::-webkit-slider-track {
            background: linear-gradient(to right, #9333EA, #EC4899, #FF6B35);
            height: 6px;
            border-radius: 3px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
            transition: transform 0.15s ease;
            border: 2px solid #38bdf8;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }
        
        input[type="range"]::-moz-range-track {
            background: linear-gradient(to right, #9333EA, #EC4899, #FF6B35);
            height: 6px;
            border-radius: 3px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 2px solid #38bdf8;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <header class="mb-8 pb-6 border-b border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-4xl font-black text-black mb-2">BULLER'S ALGORITHM (ECTEMP)</h1>
                    <p class="text-base text-black font-light tracking-wide italic">
                        Real-Time Core Temperature Prediction
                    </p>
                </div>
                <a href="material1DSimulation.html" class="px-6 py-3 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white font-bold rounded-full transition-all duration-300 shadow-lg">
                    Fabric Performance Lab
                </a>
            </div>
        </header>

        <!-- Main content grid: Chart on left, controls on right -->
        <div class="grid grid-cols-4 gap-6">

            <!-- LEFT COLUMN: Chart and Warning Panel -->
            <div class="col-span-3 space-y-4">
                <!-- CANVAS CHART CONTAINER -->
                <div class="bg-black rounded-3xl shadow-lg p-6 relative border border-gray-800">
                    <!-- 
                      The canvas element. 
                      Width and height attributes set the *drawing buffer* size.
                      CSS classes (w-full, aspect-video) make it *display* responsively.
                    -->
                    <canvas id="tempChart" width="800" height="500" class="w-full aspect-video bg-black rounded-lg"></canvas>
                    <!-- Debug Display -->
                    <div class="absolute top-6 right-6 bg-black bg-opacity-90 px-3 py-2 rounded-lg text-xs font-mono border border-gray-700">
                        <div><span class="text-gray-400">Render FPS:</span> <span id="fpsDisplay" class="text-green-400 font-bold">60</span></div>
                        <div><span class="text-gray-400">Update Rate:</span> <span id="updateDisplay" class="text-blue-400 font-bold">0</span> Hz</div>
                        <hr class="border-gray-600 my-1">
                        <div><span class="text-gray-400">Env Stress:</span> <span id="envStressDisplay" class="text-amber-400 font-bold">0.0</span> °C/step</div>
                        <div><span class="text-gray-400">Activity:</span> <span id="activityIntensityDisplay" class="text-sky-400 font-bold">0%</span></div>
                    </div>
                </div>

                <!-- WARNING / ADVISORY PANEL -->
                <div id="advisoryPanel" class="bg-black rounded-3xl shadow-lg p-6 border-l-4 border border-gray-800">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0">
                            <svg id="advisoryIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 id="advisoryTitle" class="font-bold text-lg mb-1 text-black">Normal Core Temperature</h3>
                            <p id="advisoryMessage" class="text-sm text-black">Core temperature is within normal range. Continue monitoring.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: CONTROLS PANEL -->
            <div class="bg-black rounded-3xl shadow-lg p-8 h-fit space-y-6 col-span-1 border border-gray-800">
                
                <!-- ACTIVITY LEVEL SELECTOR (NEW) -->
                <div class="space-y-2">
                    <label for="activitySelect" class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-3">Occupational Activity</label>
                    <select id="activitySelect" class="w-full bg-gray-900 text-white border border-gray-700 rounded-xl px-3 py-3 font-medium focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="manual">Manual Control</option>
                        <optgroup label="Light Activity (1-3 METs)">
                            <option value="1.3">Sitting/Desk Work (1.3 METs)</option>
                            <option value="2.0">Standing Light Work (2.0 METs)</option>
                            <option value="2.5">Slow Walking (2.5 METs)</option>
                        </optgroup>
                        <optgroup label="Moderate Activity (3-6 METs)">
                            <option value="3.0">Light Manual Labor (3.0 METs)</option>
                            <option value="3.5">Walking 3mph (3.5 METs)</option>
                            <option value="4.5">Moderate Labor (4.5 METs)</option>
                            <option value="5.0">Brisk Walking 4mph (5.0 METs)</option>
                        </optgroup>
                        <optgroup label="Vigorous Activity (6+ METs)">
                            <option value="6.0">Heavy Lifting (6.0 METs)</option>
                            <option value="7.0">Jogging (7.0 METs)</option>
                            <option value="8.0">Very Heavy Labor (8.0 METs)</option>
                            <option value="10.0">Firefighting/Rescue (10.0 METs)</option>
                            <option value="12.0">Intense Athletics (12.0 METs)</option>
                        </optgroup>
                    </select>
                    <p class="text-xs text-gray-400">Sets heart rate based on metabolic equivalents (METs) from evidence-based activity levels.</p>
                </div>

                <hr class="border-gray-600">

                <!-- HR Slider -->
                <div class="space-y-2">
                    <div class="flex justify-between items-baseline">
                        <label for="hrSlider" class="text-base font-semibold text-gray-100">Heart Rate (HR)</label>
                        <span id="hrValue" class="text-base font-mono font-bold text-sky-400">70 bpm</span>
                    </div>
                    <input type="range" id="hrSlider" min="50" max="200" value="70" class="w-full">
                    <p class="text-xs text-gray-400">Manual override when "Manual Control" is selected above.</p>
                </div>

                <hr class="border-gray-600">

                <!-- ENVIRONMENTAL FACTORS (EXPANDED) -->
                <div class="space-y-3">
                    <h3 class="text-xl font-black text-white tracking-tight uppercase">Environmental Conditions</h3>
                    
                    <!-- Ambient Temperature -->
                    <div class="space-y-1">
                        <div class="flex justify-between items-baseline">
                            <label for="ambientTempSlider" class="text-sm text-gray-200">Air Temperature (T<sub>a</sub>)</label>
                            <span id="ambientTempValue" class="text-sm font-mono font-bold text-sky-400">20°C</span>
                        </div>
                        <input type="range" id="ambientTempSlider" min="0" max="45" value="20" step="1" class="w-full">
                    </div>

                    <!-- Relative Humidity -->
                    <div class="space-y-1">
                        <div class="flex justify-between items-baseline">
                            <label for="humiditySlider" class="text-sm text-gray-200">Relative Humidity (RH)</label>
                            <span id="humidityValue" class="text-sm font-mono font-bold text-sky-400">50%</span>
                        </div>
                        <input type="range" id="humiditySlider" min="0" max="100" value="50" step="5" class="w-full">
                    </div>
                    
                    <!-- Wind Speed -->
                    <div class="space-y-1">
                        <div class="flex justify-between items-baseline">
                            <label for="windSpeedSlider" class="text-sm text-gray-200">Wind Speed</label>
                            <span id="windSpeedValue" class="text-sm font-mono font-bold text-sky-400">0.5 m/s</span>
                        </div>
                        <input type="range" id="windSpeedSlider" min="0" max="10" value="0.5" step="0.1" class="w-full">
                    </div>
                    
                    <!-- Solar Radiation -->
                    <div class="space-y-1">
                        <div class="flex justify-between items-baseline">
                            <label for="solarRadSlider" class="text-sm text-gray-200">Solar Radiation</label>
                            <span id="solarRadValue" class="text-sm font-mono font-bold text-sky-400">400 W/m²</span>
                        </div>
                        <input type="range" id="solarRadSlider" min="0" max="1000" value="400" step="50" class="w-full">
                    </div>
                    
                    <!-- Clothing Type Dropdown -->
                    <div class="space-y-1">
                        <label for="clothingSelect" class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-2">Clothing Type</label>
                        <select id="clothingSelect" class="w-full bg-gray-900 text-white border border-gray-700 rounded-xl px-3 py-3 font-medium focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option value="manual">Manual Control</option>
                            <optgroup label="Minimal">
                                <option value="0.0">Naked / Swimming (0.0 clo)</option>
                                <option value="0.3">Underwear only (0.3 clo)</option>
                            </optgroup>
                            <optgroup label="Light Clothing">
                                <option value="0.5">Shorts + T-shirt (0.5 clo)</option>
                                <option value="0.6" selected>Light Work Clothes (0.6 clo)</option>
                                <option value="0.7">Summer Dress (0.7 clo)</option>
                            </optgroup>
                            <optgroup label="Standard Clothing">
                                <option value="0.9">Trousers + Long Sleeve (0.9 clo)</option>
                                <option value="1.0">Business Suit (1.0 clo)</option>
                                <option value="1.1">Light Coveralls (1.1 clo)</option>
                            </optgroup>
                            <optgroup label="Heavy Clothing">
                                <option value="1.4">Winter Clothing (1.4 clo)</option>
                                <option value="1.5">Heavy Work Gear (1.5 clo)</option>
                                <option value="2.0">Arctic/Winter Gear (2.0 clo)</option>
                            </optgroup>
                            <optgroup label="Protective Gear">
                                <option value="1.7">Firefighter Turnout Gear (1.7 clo)</option>
                                <option value="2.5">Hazmat Suit (2.5 clo)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Clothing Slider (for manual control) -->
                    <div class="space-y-1">
                        <div class="flex justify-between items-baseline">
                            <label for="clothingSlider" class="text-sm text-gray-200">Clothing (clo)</label>
                            <span id="clothingValue" class="text-sm font-mono font-bold text-sky-400">0.6</span>
                        </div>
                        <input type="range" id="clothingSlider" min="0" max="2.5" value="0.6" step="0.1" class="w-full">
                    </div>
                    
                    <p class="text-xs text-gray-400">
                        1 clo = insulation needed at rest in 21°C to maintain comfort. Higher = less heat dissipation.
                    </p>
                </div>

                <hr class="border-gray-600">

                <!-- INDIVIDUAL PARAMETERS -->
                <div class="space-y-3">
                    <h3 class="text-xl font-black text-white tracking-tight uppercase">Individual Parameters</h3>
                    
                    <!-- Resting HR -->
                    <div class="space-y-1">
                        <div class="flex justify-between items-baseline">
                            <label for="restingHRSlider" class="text-sm text-gray-200">Resting Heart Rate</label>
                            <span id="restingHRValue" class="text-sm font-mono font-bold text-sky-400">60 bpm</span>
                        </div>
                        <input type="range" id="restingHRSlider" min="40" max="100" value="60" step="1" class="w-full">
                    </div>

                    <!-- Age -->
                    <div class="space-y-1">
                        <div class="flex justify-between items-baseline">
                            <label for="ageSlider" class="text-sm text-gray-200">Age (years)</label>
                            <span id="ageValue" class="text-sm font-mono font-bold text-sky-400">30</span>
                        </div>
                        <input type="range" id="ageSlider" min="18" max="70" value="30" step="1" class="w-full">
                    </div>
                    
                    <p class="text-xs text-gray-400">Used for calculating max HR (220 - age) and activity HR.</p>
                </div>

                <hr class="border-gray-600">

                <!-- Initial CT Slider -->
                <div class="space-y-2">
                    <div class="flex justify-between items-baseline">
                        <label for="ctSlider" class="text-base font-semibold text-gray-100">Initial Core Temp (CT₀)</label>
                        <span id="ctValue" class="text-base font-mono font-bold text-sky-400">37.1 °C</span>
                    </div>
                    <input type="range" id="ctSlider" min="36.0" max="38.0" value="37.1" step="0.1" class="w-full">
                    <p class="text-xs text-gray-400">Sets the starting temperature. Resets the chart.</p>
                </div>

                <!-- Initial Variance Slider -->
                <div class="space-y-2">
                    <div class="flex justify-between items-baseline">
                        <label for="vSlider" class="text-base font-semibold text-gray-100">Initial Variance (v₀)</label>
                        <span id="vValue" class="text-base font-mono font-bold text-sky-400">0.02</span>
                    </div>
                    <input type="range" id="vSlider" min="0.01" max="1.0" value="0.02" step="0.01" class="w-full">
                    <p class="text-xs text-gray-400">Model's initial confidence. Lower = more confident.</p>
                </div>

                <hr class="border-gray-600">

                <!-- NEW: Simulation Speed Control -->
                <div class="space-y-2">
                    <div class="flex justify-between items-baseline">
                        <label for="speedSlider" class="text-base font-semibold text-gray-100">Simulation Speed</label>
                        <span id="speedValue" class="text-base font-mono font-bold text-sky-400">60 Hz</span>
                    </div>
                    <input type="range" id="speedSlider" min="1" max="60" value="60" step="1" class="w-full">
                    <p class="text-xs text-gray-400">Updates per second. Default: 60 Hz for smooth real-time simulation.</p>
                </div>
                
                <!-- NEW: Environment Influence Control -->
                <div class="space-y-2">
                    <div class="flex justify-between items-baseline">
                        <label for="envInfluenceSlider" class="text-base font-semibold text-gray-100">Environment Influence</label>
                        <span id="envInfluenceValue" class="text-base font-mono font-bold text-sky-400">50%</span>
                    </div>
                    <input type="range" id="envInfluenceSlider" min="0" max="100" value="50" step="5" class="w-full">
                    <p class="text-xs text-gray-400">
                        <span class="text-amber-400">⚠️</span> Experimental: Controls how much environmental factors affect core temp. 
                        No established evidence for combining Buller's HR-based model with environmental factors.
                    </p>
                </div>

                <!-- Reset Button -->
                <button id="resetButton" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:from-red-700 hover:to-red-800 transition-all duration-300">
                    Reset Simulation
                </button>
            </div>
            
        </div>
    </div>

    <script>
        // --- I. SETUP AND STATE ---

        // A. Algorithm Constants (from literature)
        const PROCESS_NOISE = 0.000484; // Q
        const MEASUREMENT_NOISE = 356.4544; // R
        
        // B. Algorithm State Variables
        let currentCT; // Current Core Temperature
        let currentV;  // Current Variance
        
        // C. Graphing State
        let dataPoints = []; // Array to hold temperature history
        let graphWidth;      // Pixel width of the graph area
        const Y_MIN = 36.0;  // Min temp on Y-axis
        const Y_MAX = 41.0;  // Max temp on Y-axis
        const PADDING = 60;  // Pixel padding around the graph
        
        // D. Environmental/Individual Parameters
        let ambientTemp = 20;     // Celsius
        let relativeHumidity = 50; // Percentage
        let windSpeed = 0.5;       // m/s
        let solarRadiation = 400;  // W/m²
        let clothingInsulation = 0.6; // clo units
        let restingHR = 60;        // bpm
        let age = 30;              // years
        
        // E. Simulation Timing Control
        let updatesPerSecond = 60;  // Hz - how many times per second to update (default 60 Hz)
        let lastUpdateTime = 0;     // Timestamp of last update
        let actualUpdateRate = 0;   // Measured update rate
        let updateCount = 0;        // Count of updates
        let lastUpdateRateCheck = 0; // Time of last rate calculation
        let simulationStartTime = 0; // When simulation started
        let elapsedSimulationTime = 0; // Total elapsed time in seconds
        let environmentInfluence = 0.5; // 0-1 scale, controls environmental factor strength (default 50%)
        
        // F. FPS Tracking
        let fps = 0;
        let frameCount = 0;
        let lastFpsCheck = 0;
        
        // G. DOM Element References
        const hrSlider = document.getElementById('hrSlider');
        const hrValue = document.getElementById('hrValue');
        const ctSlider = document.getElementById('ctSlider');
        const ctValue = document.getElementById('ctValue');
        const vSlider = document.getElementById('vSlider');
        const vValue = document.getElementById('vValue');
        const resetButton = document.getElementById('resetButton');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const envInfluenceSlider = document.getElementById('envInfluenceSlider');
        const envInfluenceValue = document.getElementById('envInfluenceValue');
        const fpsDisplay = document.getElementById('fpsDisplay');
        const updateDisplay = document.getElementById('updateDisplay');
        const envStressDisplay = document.getElementById('envStressDisplay');
        const activityIntensityDisplay = document.getElementById('activityIntensityDisplay');
        
        // Activity and Environmental Controls
        const activitySelect = document.getElementById('activitySelect');
        const ambientTempSlider = document.getElementById('ambientTempSlider');
        const ambientTempValue = document.getElementById('ambientTempValue');
        const humiditySlider = document.getElementById('humiditySlider');
        const humidityValue = document.getElementById('humidityValue');
        const windSpeedSlider = document.getElementById('windSpeedSlider');
        const windSpeedValue = document.getElementById('windSpeedValue');
        const solarRadSlider = document.getElementById('solarRadSlider');
        const solarRadValue = document.getElementById('solarRadValue');
        const clothingSelect = document.getElementById('clothingSelect');
        const clothingSlider = document.getElementById('clothingSlider');
        const clothingValue = document.getElementById('clothingValue');
        const restingHRSlider = document.getElementById('restingHRSlider');
        const restingHRValue = document.getElementById('restingHRValue');
        const ageSlider = document.getElementById('ageSlider');
        const ageValue = document.getElementById('ageValue');
        
        // Advisory Panel Elements
        const advisoryPanel = document.getElementById('advisoryPanel');
        const advisoryIcon = document.getElementById('advisoryIcon');
        const advisoryTitle = document.getElementById('advisoryTitle');
        const advisoryMessage = document.getElementById('advisoryMessage');
        
        // H. Canvas Setup
        const canvas = document.getElementById('tempChart');
        const ctx = canvas.getContext('2d');
        graphWidth = canvas.width - PADDING * 2; // Usable width for the line
        
        // I. Drawing Optimization - Cache static elements
        let cachedStaticElements = null; // Will store background/zones as ImageData

        // --- II. EVIDENCE-BASED WARNING THRESHOLDS ---
        const TEMP_THRESHOLDS = {
            normal: { max: 37.2, color: '#10b981', borderColor: '#10b981' },      // green
            elevated: { max: 38.0, color: '#f59e0b', borderColor: '#f59e0b' },    // amber
            warning: { max: 39.0, color: '#ef4444', borderColor: '#ef4444' },     // red
            danger: { max: 42.0, color: '#dc2626', borderColor: '#dc2626' }       // dark red
        };

        // --- III. HELPER FUNCTIONS ---

        /**
         * Calculate heart rate from METs using evidence-based formula
         * Formula: Activity HR = ((METs + 5) / 6) × Resting HR
         * Source: PMC9586849
         */
        function calculateHRFromMETs(mets, restingHR) {
            return Math.round(((mets + 5) / 6) * restingHR);
        }

        /**
         * Calculate maximum heart rate from age (220 - age)
         */
        function calculateMaxHR(age) {
            return 220 - age;
        }

        /**
         * EVIDENCE-BASED: Calculate Heat Index from temperature and humidity
         * Based on Rothfusz regression (NWS/NOAA)
         * Returns perceived temperature in Celsius
         * 
         * NOTE: Buller's original algorithm does NOT include environmental factors.
         * This is an extension showing how environmental heat stress affects
         * thermal strain during physical activity.
         * 
         * Source: NWS Heat Index equation
         */
        function calculateHeatIndex(tempC, relativeHumidity) {
            // Convert to Fahrenheit for the NWS formula
            const T = (tempC * 9/5) + 32;
            const RH = relativeHumidity;
            
            // Simple formula for T < 80°F
            if (T < 80) {
                return tempC; // No significant heat index effect
            }
            
            // Rothfusz regression (full equation for accuracy)
            let HI = -42.379 
                + 2.04901523 * T 
                + 10.14333127 * RH 
                - 0.22475541 * T * RH 
                - 6.83783e-3 * T * T 
                - 5.481717e-2 * RH * RH 
                + 1.22874e-3 * T * T * RH 
                + 8.5282e-4 * T * RH * RH 
                - 1.99e-6 * T * T * RH * RH;
            
            // Adjustments for extreme conditions
            if (RH < 13 && T >= 80 && T <= 112) {
                HI -= ((13 - RH) / 4) * Math.sqrt((17 - Math.abs(T - 95)) / 17);
            }
            else if (RH > 85 && T >= 80 && T <= 87) {
                HI += ((RH - 85) / 10) * ((87 - T) / 5);
            }
            
            // Convert back to Celsius
            const heatIndexC = (HI - 32) * 5/9;
            return heatIndexC;
        }
        
        /**
         * EVIDENCE-BASED: Calculate comprehensive environmental heat stress
         * Combines multiple factors: Heat Index, wind, solar radiation, clothing
         * 
         * ⚠️ IMPORTANT CAVEAT:
         * There is NO established evidence-based method for combining Buller's 
         * HR-based ECTemp algorithm with environmental models (WBGT, Heat Index, etc.).
         * These are separate prediction methods developed independently.
         * 
         * This implementation is EXPERIMENTAL - we're creating a hybrid approach
         * where environmental factors modify the HR-based core temp prediction.
         * The "Environment Influence" slider (0-100%) allows exploration of different
         * coupling strengths since the "correct" value is unknown.
         * 
         * Research basis for individual components:
         * - Heat Index: Temperature + humidity (evaporative cooling impairment)
         * - Wind speed: Enhances convective cooling (ISO 7243, ISO 7933)
         * - Solar radiation: Adds radiant heat load (WBGT model)
         * - Clothing: Impedes heat dissipation (clo units standard)
         */
        function calculateEnvironmentalStress(tempC, humidity, wind, solar, clothing) {
            // 1. Base Heat Index (temp + humidity effect)
            const heatIndex = calculateHeatIndex(tempC, humidity);
            let effectiveTemp = heatIndex;
            
            // 2. Wind cooling effect (convective heat transfer)
            // Wind reduces effective temperature via enhanced convection
            // Based on wind chill principles adapted for heat (ISO 7933)
            // Significant effect up to ~5 m/s, diminishing returns after
            if (wind > 0.1) {
                const windCooling = Math.min(5, wind) * 0.8; // °C reduction per m/s (max 4°C)
                effectiveTemp -= windCooling;
            }
            
            // 3. Solar radiation heat load (radiant heat gain)
            // Solar adds to thermal load, especially during outdoor work
            // Based on WBGT outdoor calculation principles
            // ~200-300 W/m² ≈ 2-3°C additional heat stress (depends on clothing)
            const solarLoad = (solar / 200) * (0.5 + clothing * 0.5); // Modified by clothing absorption
            effectiveTemp += solarLoad;
            
            // 4. Clothing insulation effect
            // Higher clo = impaired heat dissipation
            // Standard: 0.6 clo (light work clothes) as baseline
            // Each 0.1 clo above baseline adds ~0.3°C effective temp
            const clothingEffect = Math.max(0, clothing - 0.6) * 3.0; // °C per clo above baseline
            effectiveTemp += clothingEffect;
            
            // 5. Calculate net heat stress
            const heatStressDelta = effectiveTemp - tempC;
            
            // Return heat stress increment per algorithm step
            // Positive = heat gain, Negative = enhanced cooling
            if (heatStressDelta !== 0) {
                // Increased scaling for more visible effect
                // At 10 Hz update rate: 0.1 = ~0.1°C per second at full activity intensity
                return heatStressDelta * 0.1; // Scaling factor for per-step increment
            }
            return 0;
        }

        /**
         * Get warning status based on current core temperature
         */
        function getWarningStatus(temp) {
            if (temp <= TEMP_THRESHOLDS.normal.max) {
                return {
                    level: 'normal',
                    title: 'Normal Core Temperature',
                    message: 'Core temperature is within normal range (36.1-37.2°C). Continue monitoring.',
                    icon: 'info',
                    ...TEMP_THRESHOLDS.normal
                };
            } else if (temp <= TEMP_THRESHOLDS.elevated.max) {
                return {
                    level: 'elevated',
                    title: 'Elevated Core Temperature - CAUTION',
                    message: 'Core temperature is elevated (37.3-38.0°C). Monitor closely. Consider reducing activity intensity, ensure adequate hydration, and seek cooler environment if possible.',
                    icon: 'warning',
                    ...TEMP_THRESHOLDS.elevated
                };
            } else if (temp <= TEMP_THRESHOLDS.warning.max) {
                return {
                    level: 'warning',
                    title: 'High Core Temperature - WARNING',
                    message: 'Moderate hyperthermia detected (38.1-39.0°C). CEASE activity immediately. Move to cooler environment. Hydrate. Remove excess clothing. Monitor for heat exhaustion symptoms.',
                    icon: 'warning',
                    ...TEMP_THRESHOLDS.warning
                };
            } else {
                return {
                    level: 'danger',
                    title: 'CRITICAL Core Temperature - DANGER',
                    message: 'Severe hyperthermia (>39.0°C). MEDICAL EMERGENCY. Implement active cooling immediately. Seek emergency medical attention. High risk of heat stroke.',
                    icon: 'danger',
                    ...TEMP_THRESHOLDS.danger
                };
            }
        }

        /**
         * Update the advisory panel based on current temperature
         */
        function updateAdvisoryPanel() {
            const status = getWarningStatus(currentCT);
            
            advisoryPanel.style.borderLeftColor = status.borderColor;
            advisoryPanel.style.backgroundColor = status.color + '15'; // 15 = ~8% opacity
            advisoryTitle.textContent = status.title;
            advisoryTitle.style.color = '#000000'; // Black text for visibility
            advisoryMessage.textContent = status.message;
            advisoryIcon.style.color = status.color;
            
            // Update icon based on severity
            if (status.level === 'normal') {
                advisoryIcon.innerHTML = '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>';
            } else if (status.level === 'elevated') {
                advisoryIcon.innerHTML = '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>';
            } else {
                advisoryIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>';
            }
        }

        // --- IV. EVENT LISTENERS ---

        // Activity selector
        activitySelect.addEventListener('change', (e) => {
            if (e.target.value !== 'manual') {
                const mets = parseFloat(e.target.value);
                const calculatedHR = calculateHRFromMETs(mets, restingHR);
                hrSlider.value = calculatedHR;
                hrValue.textContent = `${calculatedHR} bpm`;
            }
        });

        // Update slider readouts on input
        hrSlider.addEventListener('input', (e) => {
            hrValue.textContent = `${e.target.value} bpm`;
            // Reset activity selector to manual when HR is manually changed
            activitySelect.value = 'manual';
        });
        
        ctSlider.addEventListener('input', (e) => {
            ctValue.textContent = `${parseFloat(e.target.value).toFixed(1)} °C`;
            resetSimulation(); // Reset if initial conditions change
        });
        
        vSlider.addEventListener('input', (e) => {
            vValue.textContent = `${parseFloat(e.target.value).toFixed(2)}`;
            resetSimulation(); // Reset if initial conditions change
        });
        
        // NEW: Environmental controls
        ambientTempSlider.addEventListener('input', (e) => {
            ambientTemp = parseFloat(e.target.value);
            ambientTempValue.textContent = `${ambientTemp}°C`;
        });
        
        humiditySlider.addEventListener('input', (e) => {
            relativeHumidity = parseFloat(e.target.value);
            humidityValue.textContent = `${relativeHumidity}%`;
        });
        
        windSpeedSlider.addEventListener('input', (e) => {
            windSpeed = parseFloat(e.target.value);
            windSpeedValue.textContent = `${windSpeed.toFixed(1)} m/s`;
        });
        
        solarRadSlider.addEventListener('input', (e) => {
            solarRadiation = parseFloat(e.target.value);
            solarRadValue.textContent = `${solarRadiation} W/m²`;
        });
        
        // Clothing type selector
        clothingSelect.addEventListener('change', (e) => {
            if (e.target.value !== 'manual') {
                const cloValue = parseFloat(e.target.value);
                clothingInsulation = cloValue;
                clothingSlider.value = cloValue;
                clothingValue.textContent = `${cloValue.toFixed(1)}`;
            }
        });
        
        clothingSlider.addEventListener('input', (e) => {
            clothingInsulation = parseFloat(e.target.value);
            clothingValue.textContent = `${clothingInsulation.toFixed(1)}`;
            // Reset clothing selector to manual when slider is manually changed
            clothingSelect.value = 'manual';
        });
        
        // NEW: Individual parameter controls
        restingHRSlider.addEventListener('input', (e) => {
            restingHR = parseFloat(e.target.value);
            restingHRValue.textContent = `${restingHR} bpm`;
            // Re-calculate activity HR if an activity is selected
            if (activitySelect.value !== 'manual') {
                const mets = parseFloat(activitySelect.value);
                const calculatedHR = calculateHRFromMETs(mets, restingHR);
                hrSlider.value = calculatedHR;
                hrValue.textContent = `${calculatedHR} bpm`;
            }
        });
        
        ageSlider.addEventListener('input', (e) => {
            age = parseFloat(e.target.value);
            ageValue.textContent = `${age}`;
        });
        
        // NEW: Speed control
        speedSlider.addEventListener('input', (e) => {
            updatesPerSecond = parseFloat(e.target.value);
            speedValue.textContent = `${updatesPerSecond} Hz`;
        });
        
        // NEW: Environment influence control
        envInfluenceSlider.addEventListener('input', (e) => {
            environmentInfluence = parseFloat(e.target.value) / 100; // Convert to 0-1 scale
            envInfluenceValue.textContent = `${e.target.value}%`;
        });
        
        resetButton.addEventListener('click', resetSimulation);

        // --- V. CORE ALGORITHM LOGIC ---

        /**
         * Resets the simulation to the initial slider values.
         */
        function resetSimulation() {
            currentCT = parseFloat(ctSlider.value);
            currentV = parseFloat(vSlider.value);
            dataPoints = [currentCT]; // Start history with the initial value
            elapsedSimulationTime = 0; // Reset simulation time
            simulationStartTime = performance.now(); // Record new start time
            // Redraw static background to clear old data
            drawStaticBackground();
        }

        /**
         * Performs one step of the Buller (ECTemp) Kalman filter.
         * EXTENDED: Now includes environmental heat stress factors
         */
        function runAlgorithmStep() {
            const hr = parseFloat(hrSlider.value);
            
            // 1. Predict next state
            const ct_pre = currentCT;
            const v_pre = currentV + PROCESS_NOISE;
            
            // 2. Calculate Kalman Gain
            const m = -9.1428 * ct_pre + 384.4286;
            const k_gain = (v_pre * m) / (m * m * v_pre + MEASUREMENT_NOISE);
            
            // 3. Calculate expected HR from predicted temp
            const expectedHR = (-4.5714 * ct_pre * ct_pre) + (384.4286 * ct_pre) - 7887.1;
            
            // 4. Update estimate with measurement
            const error = hr - expectedHR;
            currentCT = ct_pre + (k_gain * error);
            
            // 5. EVIDENCE-BASED: Apply comprehensive environmental heat stress
            // Combines Heat Index, wind, solar radiation, and clothing effects
            // Only applies during physical activity (HR > resting)
            let envStress = 0;
            let activityIntensity = 0;
            
            if (hr > restingHR) {
                envStress = calculateEnvironmentalStress(
                    ambientTemp, 
                    relativeHumidity, 
                    windSpeed, 
                    solarRadiation, 
                    clothingInsulation
                );
                
                if (envStress !== 0) { // Can be positive (heat gain) or negative (enhanced cooling)
                    // Activity intensity (0-1 scale)
                    activityIntensity = Math.min(1.0, (hr - restingHR) / (calculateMaxHR(age) - restingHR));
                    
                    // Environmental stress affects core temp during activity
                    // Higher activity = more metabolic heat + stronger environmental influence
                    // envStress already scaled in calculateEnvironmentalStress()
                    // APPLY ENVIRONMENT INFLUENCE MULTIPLIER (0-100% user control)
                    const heatIncrement = envStress * activityIntensity * environmentInfluence;
                    currentCT += heatIncrement;
                }
            }
            
            // Update debug displays
            envStressDisplay.textContent = envStress.toFixed(4);
            activityIntensityDisplay.textContent = `${(activityIntensity * 100).toFixed(0)}%`;
            
            // 6. Update variance
            currentV = (1 - k_gain * m) * v_pre;

            // 7. Update data for graph
            dataPoints.push(currentCT);
            
            // Update elapsed time (each step represents 1/updatesPerSecond)
            elapsedSimulationTime += (1 / updatesPerSecond);
            
            // Make the graph scroll by removing old data
            if (dataPoints.length > graphWidth) {
                dataPoints.shift();
            }
        }

        // --- VI. CANVAS DRAWING LOGIC ---

        /**
         * Helper function to map a temperature value to a Y-pixel coordinate.
         */
        function mapY(temp) {
            const graphHeight = canvas.height - PADDING * 2;
            const tempRange = Y_MAX - Y_MIN;
            // Invert Y-axis (0 is top, canvas.height is bottom)
            return canvas.height - PADDING - ((temp - Y_MIN) / tempRange) * graphHeight;
        }
        
        /**
         * Format elapsed time as MM:SS or HH:MM:SS
         */
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hrs > 0) {
                return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        /**
         * OPTIMIZED: Draw static background elements (grid, zones, axes)
         * Called once and cached
         */
        function drawStaticBackground() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Grid & Y-Axis Labels
            ctx.strokeStyle = '#374151';
            ctx.fillStyle = '#d1d5db';
            ctx.font = "14px 'Fira Code', monospace";
            ctx.lineWidth = 1;
            
            for (let temp = Y_MIN; temp <= Y_MAX; temp += 0.5) {
                const y = mapY(temp);
                ctx.beginPath();
                ctx.moveTo(PADDING, y);
                ctx.lineTo(canvas.width - PADDING, y);
                ctx.stroke();
                
                if (temp % 1 === 0) {
                    ctx.textAlign = 'right';
                    ctx.fillText(`${temp.toFixed(1)}°C`, PADDING - 10, y + 5);
                }
            }
            
            // Draw Warning Temperature Zones
            const y_normal_top = mapY(TEMP_THRESHOLDS.normal.max);
            const y_normal_bottom = mapY(Y_MIN);
            ctx.fillStyle = 'rgba(16, 185, 129, 0.12)';
            ctx.fillRect(PADDING, y_normal_top, graphWidth, y_normal_bottom - y_normal_top);
            
            const y_elevated_top = mapY(TEMP_THRESHOLDS.elevated.max);
            const y_elevated_bottom = mapY(TEMP_THRESHOLDS.normal.max);
            ctx.fillStyle = 'rgba(245, 158, 11, 0.15)';
            ctx.fillRect(PADDING, y_elevated_top, graphWidth, y_elevated_bottom - y_elevated_top);
            
            const y_warning_top = mapY(TEMP_THRESHOLDS.warning.max);
            const y_warning_bottom = mapY(TEMP_THRESHOLDS.elevated.max);
            ctx.fillStyle = 'rgba(239, 68, 68, 0.15)';
            ctx.fillRect(PADDING, y_warning_top, graphWidth, y_warning_bottom - y_warning_top);
            
            const y_danger_top = mapY(Y_MAX);
            const y_danger_bottom = mapY(TEMP_THRESHOLDS.warning.max);
            ctx.fillStyle = 'rgba(220, 38, 38, 0.2)';
            ctx.fillRect(PADDING, y_danger_top, graphWidth, y_danger_bottom - y_danger_top);
            
            // Zone labels
            ctx.font = "11px 'Fira Code', monospace";
            ctx.textAlign = 'left';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.fillText('Normal', PADDING + 5, y_normal_top + 15);
            ctx.fillText('Caution', PADDING + 5, y_elevated_top + 15);
            ctx.fillText('Warning', PADDING + 5, y_warning_top + 15);
            ctx.fillText('Danger', PADDING + 5, y_danger_top + 15);

            // X-Axis (Time)
            ctx.strokeStyle = '#4b5563';
            ctx.beginPath();
            const y_axis_base = mapY(Y_MIN);
            ctx.moveTo(PADDING, y_axis_base);
            ctx.lineTo(canvas.width - PADDING, y_axis_base);
            ctx.stroke();
            
            // Draw time tick marks every 100 pixels
            ctx.strokeStyle = '#6b7280';
            ctx.lineWidth = 1;
            for (let x = PADDING; x <= canvas.width - PADDING; x += 100) {
                ctx.beginPath();
                ctx.moveTo(x, y_axis_base);
                ctx.lineTo(x, y_axis_base + 5);
                ctx.stroke();
            }
            
            // X-Axis label
            ctx.textAlign = 'center';
            ctx.fillStyle = '#d1d5db';
            ctx.font = "12px 'Fira Code', monospace";
            ctx.fillText('Time (Elapsed)', canvas.width / 2, canvas.height - PADDING / 4);
            
            // Cache this static background
            cachedStaticElements = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }

        /**
         * OPTIMIZED: Draw only dynamic elements (data line, dot, current values)
         * Called every frame
         */
        function drawChart() {
            // Restore cached background (much faster than redrawing)
            if (cachedStaticElements) {
                ctx.putImageData(cachedStaticElements, 0, 0);
            } else {
                drawStaticBackground();
            }

            // Draw the Temperature Fill (Gradient Area)
            const baseLineY = mapY(Y_MIN);
            const fillGrad = ctx.createLinearGradient(0, mapY(Y_MAX), 0, baseLineY);
            fillGrad.addColorStop(0, 'rgba(59, 130, 246, 0.4)'); // blue-500 @ 40%
            fillGrad.addColorStop(1, 'rgba(59, 130, 246, 0.0)'); // blue-500 @ 0%

            ctx.beginPath();
            ctx.moveTo(PADDING, baseLineY);
            for (let i = 0; i < dataPoints.length; i++) {
                ctx.lineTo(PADDING + i, mapY(dataPoints[i]));
            }
            ctx.lineTo(PADDING + dataPoints.length - 1, baseLineY);
            ctx.closePath();
            ctx.fillStyle = fillGrad;
            ctx.fill();

            // OPTIMIZED: Draw temperature line with batched segments by color
            if (dataPoints.length > 0) {
                ctx.lineWidth = 3;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetY = 2;
                
                // Get current status for consistent coloring
                const currentStatus = getWarningStatus(currentCT);
                ctx.strokeStyle = currentStatus.color;
                ctx.shadowColor = currentStatus.color + '60';
                
                // Draw entire line in one path for performance
                ctx.beginPath();
                ctx.moveTo(PADDING, mapY(dataPoints[0]));
                for (let i = 1; i < dataPoints.length; i++) {
                    ctx.lineTo(PADDING + i, mapY(dataPoints[i]));
                }
                ctx.stroke();
                ctx.shadowColor = 'transparent';
            }

            // OPTIMIZED: Draw Current Measurement Indicator (Dot) - simplified
            if (dataPoints.length > 0) {
                const currentX = PADDING + dataPoints.length - 1;
                const currentY = mapY(currentCT);
                const currentStatus = getWarningStatus(currentCT);
                
                // Outer glow (single operation)
                ctx.fillStyle = currentStatus.color + '40';
                ctx.beginPath();
                ctx.arc(currentX, currentY, 10, 0, 2 * Math.PI);
                ctx.fill();
                
                // Middle ring
                ctx.fillStyle = currentStatus.color;
                ctx.beginPath();
                ctx.arc(currentX, currentY, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // Inner white dot
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(currentX, currentY, 3, 0, 2 * Math.PI);
                ctx.fill();
            }

            // Draw current value readout on chart
            const currentStatus = getWarningStatus(currentCT);
            ctx.fillStyle = currentStatus.color;
            ctx.font = "bold 20px 'Lexend', sans-serif";
            ctx.textAlign = 'left';
            ctx.fillText(`${currentCT.toFixed(2)} °C`, PADDING + 10, PADDING - 10);
            
            // Draw comprehensive environmental info
            const heatIndex = calculateHeatIndex(ambientTemp, relativeHumidity);
            const envStress = calculateEnvironmentalStress(
                ambientTemp, relativeHumidity, windSpeed, solarRadiation, clothingInsulation
            );
            const effectiveTemp = ambientTemp + (envStress * 100); // Convert back to temp difference
            
            ctx.font = "11px 'Fira Code', monospace";
            ctx.fillStyle = '#9ca3af';
            let yOffset = PADDING + 10;
            
            // Line 1: Basic environment
            ctx.fillText(`Env: ${ambientTemp}°C, ${relativeHumidity}% RH, Wind: ${windSpeed.toFixed(1)} m/s`, PADDING + 10, yOffset);
            yOffset += 14;
            
            // Line 2: Solar and clothing
            ctx.fillText(`Solar: ${solarRadiation} W/m², Clothing: ${clothingInsulation.toFixed(1)} clo`, PADDING + 10, yOffset);
            yOffset += 14;
            
            // Line 3: Effective temperature (shows combined effect)
            const tempDelta = effectiveTemp - ambientTemp;
            if (Math.abs(tempDelta) > 0.5) {
                if (tempDelta > 0) {
                    ctx.fillStyle = '#f59e0b'; // Amber for heat stress
                    ctx.fillText(`Effective Temp: ${effectiveTemp.toFixed(1)}°C (feels +${tempDelta.toFixed(1)}°C)`, PADDING + 10, yOffset);
                } else {
                    ctx.fillStyle = '#60a5fa'; // Blue for cooling
                    ctx.fillText(`Effective Temp: ${effectiveTemp.toFixed(1)}°C (feels ${tempDelta.toFixed(1)}°C)`, PADDING + 10, yOffset);
                }
            }
            
            // Draw dynamic time labels on x-axis
            const y_axis_base = mapY(Y_MIN);
            ctx.font = "11px 'Fira Code', monospace";
            ctx.fillStyle = '#9ca3af';
            ctx.textAlign = 'center';
            
            // Calculate time range visible on graph
            const timePerPixel = elapsedSimulationTime / dataPoints.length;
            const startTime = Math.max(0, elapsedSimulationTime - (graphWidth * timePerPixel));
            
            // Draw time labels every 100 pixels
            for (let x = PADDING; x <= canvas.width - PADDING; x += 100) {
                const pixelOffset = x - PADDING;
                const timeAtPixel = startTime + (pixelOffset * timePerPixel);
                ctx.fillText(formatTime(timeAtPixel), x, canvas.height - PADDING / 2.2);
            }
            
            // Always show current time at the right edge
            ctx.textAlign = 'right';
            ctx.fillStyle = '#60a5fa'; // Blue highlight for current time
            ctx.fillText(formatTime(elapsedSimulationTime), canvas.width - PADDING, canvas.height - PADDING / 2.2);
        }

        // --- VII. ANIMATION LOOP ---

        /**
         * The main loop, runs on every animation frame.
         * Uses frame-rate limiting to control simulation speed.
         * Visual updates happen every frame, but algorithm only updates at specified Hz.
         */
        function animationLoop(currentTime) {
            // FPS Tracking
            frameCount++;
            if (currentTime - lastFpsCheck >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsCheck = currentTime;
                fpsDisplay.textContent = fps;
            }
            
            // Calculate time since last update (in milliseconds)
            const timeSinceLastUpdate = currentTime - lastUpdateTime;
            
            // Calculate minimum time between updates based on Hz
            const minTimeBetweenUpdates = 1000 / updatesPerSecond; // ms
            
            // Only update the algorithm if enough time has passed
            if (timeSinceLastUpdate >= minTimeBetweenUpdates) {
                // Update the algorithm state
                runAlgorithmStep();
                
                // Update the advisory panel with current warnings
                updateAdvisoryPanel();
                
                // Update rate tracking
                updateCount++;
                if (currentTime - lastUpdateRateCheck >= 1000) {
                    actualUpdateRate = updateCount;
                    updateCount = 0;
                    lastUpdateRateCheck = currentTime;
                    updateDisplay.textContent = actualUpdateRate;
                }
                
                // Record this update time
                lastUpdateTime = currentTime;
            }
            
            // Always redraw the canvas for smooth visuals
            drawChart();
            
            // Request the next frame
            requestAnimationFrame(animationLoop);
        }

        // --- VIII. INITIALIZE ---
        resetSimulation();
        // Draw static background once
        drawStaticBackground();
        // Start with current timestamp
        const now = performance.now();
        lastUpdateTime = now;
        lastFpsCheck = now;
        lastUpdateRateCheck = now;
        simulationStartTime = now;
        requestAnimationFrame(animationLoop);

    </script>
</body>
</html>





